#!/usr/bin/perl

use warnings;
use strict;

use Switch 'Perl6';

my %input;
my @input_devices;
my ($name, $device, $phys, $mouse);

if (-f '/proc/bus/input/devices') {
	open(INPUT, '<', '/proc/bus/input/devices')
		or die "Unable to read '/proc/bus/input/devices': $!\n";
	PI: while (<INPUT>) {
		chomp;
		
		unless (/^./) {
			($name, $device, $phys, $mouse) = ();
			next;
		}
		
		my ($key, $val) = split '=';
		($key and $val) or next;

		$key =~ s/^\w:\s+//;

		given (lc($key)) { 
			when 'name' {
				$name = $val;
			}
			when 'handlers' {
				$val =~ /mouse(\d+)/ and $mouse = $1;
			}
			when 'phys' {
				$phys = $val;
			}
		}

		next unless (defined $mouse and $name and $phys);

		$device = '/dev/input/mice';

		given ($phys) {
			when m/^isa/ {
				given ($name) {
					when m/SynPS\/2/ {
						$phys = 'synaptics';
						$device = '/dev/psaux';
					}
					when m/AlpsPS\/2/ {
						$phys = 'alps';
						$device = '/dev/psaux';
					}
					default {
						#$phys = 'ps2';
						next PI;
					}
				}
			}
			when m/^usb/ { 
				#$phys = 'usb';
				next PI;
			}
		}
		
		$input{$mouse} = {
			'name' => $name,
			'type' => $phys,
			'device' => $device
		};

		($name, $phys, $mouse) = ();
	}
	close(INPUT);
}

if (not keys %input and -x '/usr/sbin/hwinfo') {
	open(HWINFO, '-|', '/usr/sbin/hwinfo --mouse --short')
		or die("Unable to execute hwinfo --mouse: $!\n");
	HW: while (<HWINFO>) {
		chomp;
		($name, $device, $phys) = ();
		if (m|^\s*(/dev/[^\s]+)\s+(.+)$|) {
			$device = $1;
			$name = "\"$2\"";
			if ($name and $device) {
				if ($device =~ m|/dev/tty.+\d$|) {
					$phys = 'serial';
				}
				else {
					given ($name) {
						when m/SynPS\/2/ {
							$phys = 'synaptics';
							$device = '/dev/psaux';
						}
						when m/AlpsPS\/2/ {
							$phys = 'alps';
							$device = '/dev/psaux';
						}
						default {
							next HW;
						}
					}
				}

				$mouse++;

				$input{$mouse} = {
					'name' => $name,
					'type' => $phys,
					'device' => $device
				};
			}
		}
	}
	close(HWINFO);
}			

for my $key (sort keys %input) {
	push @input_devices, '--input';
	for ('name', 'type', 'device') {
		push @input_devices, $_ . '=' . $input{$key}->{$_},
	}
}

print "XINPUT='@input_devices'\n";
