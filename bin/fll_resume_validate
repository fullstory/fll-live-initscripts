#!/bin/sh

# Copyright: Copyright (C) 2008 Kel Modderman <kel@otaku42.de>
# License:   GPL-2

PATH=/sbin:/usr/sbin:/bin:/usr/bin

unset RESUME SWAPUUID

if [ -s /etc/initramfs-tools/conf.d/resume ]; then
	. /etc/initramfs-tools/conf.d/resume
fi

if [ -n "${RESUME}" ]; then
	case "${RESUME}" in
		UUID=*|LABEL=*)
			RESUME=$(findfs "${RESUME}" 2>/dev/null)
			if [ -b "${RESUME}" ]; then
				return 0
			fi
			;;
		/dev/disk/by-*)
			RESUME=$(readlink -f "${RESUME}" 2>/dev/null)
			if [ -b "${RESUME}" ]; then
				return 0
			fi
			;;
		/dev/*)
			if [ -b "${RESUME}" ]; then
				SWAPUUID=$(blkid -t TYPE=swap -o value -s UUID ${RESUME})
			fi
			;;
	esac
fi

if [ -z "${SWAPUUID}" ]; then
	SWAPUUID=$(blkid -l -t TYPE=swap -o value -s UUID)
fi

if echo "${SWAPUUID}" | egrep -q '^\w{8}-\w{4}-\w{4}-\w{4}-\w{12}$'; then
	echo "RESUME=UUID=${SWAPUUID}" > /etc/initramfs-tools/conf.d/resume
fi 
